#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift(File.expand_path("../lib", __dir__))
require "json"
require "optparse"
require "piece_solver/pieces"
require "piece_solver/peg_rules"

options = { pegs: [] }
OptionParser.new do |opts|
  opts.on("--pegs PEGS", "Space-separated x,y triplets, e.g. '1,0 3,2 4,4'") do |str|
    options[:pegs] = str.split(/\s+/).map { |p| p.split(",").map(&:to_i) }
  end
end.parse!

# Validate pegs against allowed positions; print JSON error and exit non-zero on failure
begin
  PieceSolver::PegRules.validate!(options[:pegs], board_size: 5)
rescue ArgumentError => e
  puts JSON.pretty_generate({
    error: "invalid_pegs",
    message: e.message,
    allowed: PieceSolver::PegRules.allowed_positions(5)
  })
  exit 1
end

# For now (M1), just output piece names and orientation counts as JSON
pieces = PieceSolver::Pieces.all
summary = pieces.map { |p| [p.name, p.orientations.size] }.to_h
puts JSON.pretty_generate({
  board_size: 5,
  pegs: options[:pegs],
  pieces: summary
})
